{:title "EmacsでST言語を書く環境を作る"
 :tags  ["Emacs"]
 :layout :post
 :toc true}

st-mode.elとtree-sitterと試したけど、結局st-mode.elになった

## ST言語（ストラクチャードテキスト）
PLC向けの言語。  
ラダー言語よりは、C言語やPASCALに近い文法で、情報系の人も書きやすい。  
ノウハウがネットに皆無。  
IEC61131-3で規格化されてるので、そういった文書はありはするが。

## Emacs用の拡張
Melpaには登録がないが、[wadoon/st-mode](https://github.com/wadoon/st-mode)があった。  
これでシンタックスハイライトとインデントは大体できた。  
が、細かいところバグってたので、tree-sitterがないか検索。

## ST言語のtree-sitterを探す
- https://github.com/kmpm/tree-sitter-iecst
- https://github.com/tmatijevich/tree-sitter-structured-text

何個かあったが、結局どちらでも一部文法はerror判定になってまともに動かなかった。  
なにより、シンタックスハイライトは自前で実装しないといけないことで挫折した。

## tree-sitterでST言語に対応する紆余曲折
まず、Cでコンパイルが必要なのが面倒。  
Windows環境で、build-essentialを用意するのが面倒。

VisualStudioは入ってるので、msbuildでやった。  
msbuildのmakefileに相当するvcxprojを0から作る必要があった。  
vcxprojはAIに生成してもらって何とかなった。

次に、Emacsに設定するまでが面倒。  
dllを`.emacs.d/tree-sitter`に配置して、  
名前を`libtree-sitter-<言語>.dll`にすれば、  
空の`<言語>-ts-mode`を作ってやれば解決かと当初思ってた。

しかし、これは構文解析が有効になるだけで、  
シンタックスハイライトは自前で実装しないといけないことが分かった。  
[Clojureで始めるTree-sitter - Conao3 Note](https://a.conao3.com/blog/2024/8b665fed/#%E3%82%B3%E3%83%BC%E3%83%89%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88)

## はまったポイントとデバッグ手法
dllはできたけどロードがちゃんとされたかわからない。  
→`treesit-language-available-p`で確認できる。  
特に第2引数を入れることで、エラー要因を取得することができる。

```elisp
(require 'treesit)
(treesit-language-available-p 'structured-text 't)
```

指定のエントリポイントがないみたいなエラーだった。  
→tree-sitterのルールで、`parser.c`の`tree_sitter_<言語>`がエントリポイントになってる。  
Emacsだと、ファイル名`libtree-sitter-<言語>.dll`の言語とエントリポイントの言語揃う必要がある。

ロードはできたけど色がつかない。  
→`(setq-local treesit-font-lock-feature-list '((<feature名>)))` が必要？  
妥当性は未検討。n=1で改善できた。

`treesit-explore-mode`を使うと、現在のファイルの構文木を見ることができる。  
そこで定義されたtypeから、font-lock設定することで、シンタックスハイライトが実現できる。

## まとめ
結局、st-mode.elをフォークして、バグ修正して使うことにした。  
[fujimotok/st-mode](https://github.com/fujimotok/st-mode) 

時間があればtree-sitterのほうもチャレンジしたいが、  
CodesysからEmacsを外部エディタとして使えるようにする方を優先してやりたい。
